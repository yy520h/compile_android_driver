name: Android内核源码拉取与上传
on:
  workflow_dispatch:
    inputs:
      android_version:
        description: '安卓版本(10-15，整数)'
        required: true
        type: number
      kernel_version:
        description: '内核版本(需与安卓版本匹配)'
        required: true
        type: string
      target_arch:
        description: '目标架构'
        required: true
        default: 'aarch64'
        type: choice
        options:
          - aarch64
          - x86_64
          - arm
          - x86

jobs:
  pull-and-upload-source:
    runs-on: ubuntu-latest
    steps:
      - name: 打印拉取参数
        run: |
          echo "========== 拉取参数 =========="
          echo "Android版本: ${{ github.event.inputs.android_version }}"
          echo "内核版本: ${{ github.event.inputs.kernel_version }}"
          echo "架构: ${{ github.event.inputs.target_arch }}"
          echo "=============================="

      - name: 安装核心依赖
        run: |
          sudo apt-get update -y && sudo apt-get upgrade -y
          sudo apt-get install -y curl git python3 python3-pip

      - name: 安装repo工具
        run: |
          curl -fsSL https://mirrors.tuna.tsinghua.edu.cn/git/git-repo -o repo
          chmod +x repo
          sudo mv repo /usr/local/bin/
          repo --version || echo "repo工具安装完成"

      - name: 校验分支有效性（适配全版本）
        id: check_branch
        run: |
          ANDROID_VER=${{ github.event.inputs.android_version }}
          KERNEL_VER=${{ github.event.inputs.kernel_version }}
          MANIFEST_URL="https://mirrors.tuna.tsinghua.edu.cn/git/android/kernel/manifest.git"
          
          # 区分Android版本的分支命名规则
          if [ $ANDROID_VER -eq 15 ]; then
            BRANCH="android${ANDROID_VER}-${KERNEL_VER}"
          else
            BRANCH="common-android${ANDROID_VER}-${KERNEL_VER}"
          fi
          
          # 校验分支是否存在
          if git ls-remote --heads $MANIFEST_URL $BRANCH > /dev/null 2>&1; then
            echo "✅ 分支 $BRANCH 存在，开始拉取"
            echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          else
            echo "❌ 错误：该分支不存在"
            echo "版本匹配表："
            echo "- Android15 → android15-6.6"
            echo "- Android14 → common-android14-6.1 / common-android14-5.15"
            echo "- Android13 → common-android13-5.15"
            echo "- Android12 → common-android12-5.10"
            exit 1
          fi

      - name: 拉取Android内核源码（清华镜像）
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/android/kernel/manifest.git \
                    -b ${{ env.BRANCH }} \
                    --depth=1 \
                    --no-repo-verify
          repo sync -j4 -c --no-tags --optimized-fetch --force-sync --retries=5

      - name: 验证源码完整性
        run: |
          if [ -d "android-kernel/common" ] && [ -f "android-kernel/common/Makefile" ]; then
            echo "✅ 源码拉取成功"
          else
            echo "❌ 源码拉取失败"
            exit 1
          fi

      - name: 上传内核源码
        uses: actions/upload-artifact@v4.6.2
        with:
          name: android-kernel-source-${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}-${{ github.event.inputs.target_arch }}
          path: android-kernel/
          retention-days: 30
          if-no-files-found: error
