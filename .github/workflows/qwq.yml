name: Android内核源码拉取（多镜像自动切换）
on:
  workflow_dispatch:
    inputs:
      android_version:
        description: '安卓版本(10-15，整数)'
        required: true
        type: number
      kernel_version:
        description: '内核版本(如6.1/6.6，需与安卓版本匹配)'
        required: true
        type: string
      target_arch:
        description: '目标架构'
        required: true
        default: 'aarch64'
        type: choice
        options:
          - aarch64
          - x86_64
          - arm
          - x86

jobs:
  pull-and-upload-source:
    runs-on: ubuntu-latest
    steps:
      - name: 打印拉取参数
        run: |
          echo "========== 拉取参数 =========="
          echo "Android版本: ${{ github.event.inputs.android_version }}"
          echo "内核版本: ${{ github.event.inputs.kernel_version }}"
          echo "架构: ${{ github.event.inputs.target_arch }}"
          echo "=============================="

      - name: 安装核心依赖
        run: |
          sudo apt-get update -y && sudo apt-get upgrade -y
          sudo apt-get install -y curl git python3 python3-pip

      - name: 安装repo工具（多地址自动 fallback）
        run: |
          # 定义repo的可用下载地址列表
          REPO_URLS=(
            "https://mirrors.tuna.tsinghua.edu.cn/git/git-repo"  # 清华镜像（稳定）
            "https://storage.googleapis.com/git-repo-downloads/repo"  # 谷歌官方（备用）
            "https://raw.githubusercontent.com/esrlabs/git-repo/stable/repo"  # 第三方镜像（应急）
          )

          # 遍历地址，尝试下载repo
          for url in "${REPO_URLS[@]}"; do
            echo "正在尝试从地址下载repo: $url"
            if curl -fsSL "$url" -o repo; then
              chmod +x repo
              sudo mv repo /usr/local/bin/
              echo "✅ repo工具从地址 $url 安装成功"
              repo --version || echo "repo版本检测完成"
              exit 0
            fi
          done

          # 所有地址均失败
          echo "❌ 所有repo下载地址均失效"
          exit 1

      - name: 自动匹配可用镜像与分支
        id: find_mirror
        run: |
          ANDROID_VER=${{ github.event.inputs.android_version }}
          KERNEL_VER=${{ github.event.inputs.kernel_version }}
          
          # 定义3个镜像的配置：[镜像名, manifest地址, 分支生成规则]
          MIRRORS=(
            "google|https://android.googlesource.com/kernel/manifest|android${ANDROID_VER}-${KERNEL_VER};common-android${ANDROID_VER}-${KERNEL_VER}"
            "tsinghua|https://mirrors.tuna.tsinghua.edu.cn/git/android/kernel/manifest.git|android${ANDROID_VER}-${KERNEL_VER};common-android${ANDROID_VER}-${KERNEL_VER}"
            "ustc|https://mirrors.ustc.edu.cn/aosp/kernel/manifest|common-android${ANDROID_VER}-${KERNEL_VER};android${ANDROID_VER}-${KERNEL_VER}"
          )

          # 遍历镜像，自动检测可用分支
          for mirror in "${MIRRORS[@]}"; do
            IFS="|" read -r mirror_name manifest_url branch_patterns <<< "$mirror"
            IFS=";" read -r branch1 branch2 <<< "$branch_patterns"
            
            for branch in "$branch1" "$branch2"; do
              echo "正在检测镜像 [$mirror_name] 的分支: $branch"
              if git ls-remote --heads "$manifest_url" "$branch" > /dev/null 2>&1; then
                echo "✅ 找到可用镜像：$mirror_name"
                echo "✅ 可用分支：$branch"
                echo "MIRROR_NAME=$mirror_name" >> $GITHUB_ENV
                echo "MANIFEST_URL=$manifest_url" >> $GITHUB_ENV
                echo "BRANCH=$branch" >> $GITHUB_ENV
                exit 0
              fi
            done
          done

          echo "❌ 所有镜像均无匹配分支"
          echo "支持的版本组合参考："
          echo "- Android15 → 6.6（谷歌/清华）"
          echo "- Android14 → 6.1/5.15（中科大/谷歌）"
          echo "- Android13 → 5.15（全镜像）"
          exit 1

      - name: 拉取内核源码（使用匹配到的镜像）
        run: |
          mkdir -p android-kernel && cd android-kernel
          echo "正在使用镜像 [${{ env.MIRROR_NAME }}] 拉取分支 ${{ env.BRANCH }}"
          repo init -u ${{ env.MANIFEST_URL }} \
                    -b ${{ env.BRANCH }} \
                    --depth=1 \
                    --no-repo-verify
          repo sync -j4 -c --no-tags --optimized-fetch --force-sync --retries=5

      - name: 验证源码完整性
        run: |
          if [ -d "android-kernel/common" ] && [ -f "android-kernel/common/Makefile" ]; then
            echo "✅ 源码拉取成功"
          else
            echo "❌ 源码拉取失败"
            exit 1
          fi

      - name: 上传内核源码
        uses: actions/upload-artifact@v4.6.2
        with:
          name: android-kernel-source-${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}-${{ github.event.inputs.target_arch }}
          path: android-kernel/
          retention-days: 30
          if-no-files-found: error
