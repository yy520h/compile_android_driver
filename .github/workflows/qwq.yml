name: Android内核源码拉取与上传
on:
  workflow_dispatch:
    inputs:
      android_version:
        description: '安卓版本(10-15，整数)'
        required: true
        type: number
      kernel_version:
        description: '内核版本(需与安卓版本匹配，如Android15→6.6/6.1)'
        required: true
        type: string
      target_arch:
        description: '目标架构'
        required: true
        default: 'aarch64'
        type: choice
        options:
          - aarch64
          - x86_64
          - arm
          - x86

jobs:
  pull-and-upload-source:
    runs-on: ubuntu-latest
    steps:
      - name: 打印拉取参数
        run: |
          echo "========== 拉取参数 =========="
          echo "Android版本: ${{ github.event.inputs.android_version }}"
          echo "内核版本: ${{ github.event.inputs.kernel_version }}"
          echo "架构: ${{ github.event.inputs.target_arch }}"
          echo "=============================="

      - name: 安装核心依赖
        run: |
          sudo apt-get update -y && sudo apt-get upgrade -y
          sudo apt-get install -y curl git python3 python3-pip

      - name: 安装repo工具
        run: |
          curl -fsSL https://mirrors.tuna.tsinghua.edu.cn/git/git-repo -o repo
          chmod +x repo
          sudo mv repo /usr/local/bin/
          repo --version || echo "repo工具安装完成"

      - name: 校验分支有效性（适配Android 15）
        id: check_branch
        run: |
          ANDROID_VER=${{ github.event.inputs.android_version }}
          KERNEL_VER=${{ github.event.inputs.kernel_version }}
          # Android 15的分支命名规则：无common前缀，直接是android{版本}-{内核版本}
          BRANCH="android${ANDROID_VER}-${KERNEL_VER}"
          # 清华镜像manifest地址（替代谷歌源）
          MANIFEST_URL="https://mirrors.tuna.tsinghua.edu.cn/git/android/kernel/manifest.git"
          
          # 校验分支是否存在
          if git ls-remote --heads $MANIFEST_URL $BRANCH > /dev/null 2>&1; then
            echo "✅ 分支 $BRANCH 存在，开始拉取"
            echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          else
            echo "❌ 错误：该分支不存在"
            echo "Android 15推荐分支：android15-6.6（官方新核心）、android14-6.1（兼容核心）"
            echo "其他版本推荐：Android14→6.1/5.15 | Android13→5.15"
            exit 1
          fi

      - name: 拉取Android内核源码（清华镜像）
        run: |
          mkdir -p android-kernel && cd android-kernel
          # 用清华镜像初始化repo
          repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/android/kernel/manifest.git \
                    -b ${{ env.BRANCH }} \
                    --depth=1 \
                    --no-repo-verify
          # 同步源码（降低并发+重试）
          repo sync -j4 -c --no-tags --optimized-fetch --force-sync --retries=5

      - name: 验证源码完整性
        run: |
          if [ -d "android-kernel/common" ] && [ -f "android-kernel/common/Makefile" ]; then
            echo "✅ 源码拉取成功"
          else
            echo "❌ 源码拉取失败"
            exit 1
          fi

      - name: 上传内核源码
        uses: actions/upload-artifact@v4.6.2
        with:
          name: android-kernel-source-${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}-${{ github.event.inputs.target_arch }}
          path: android-kernel/
          retention-days: 30
          if-no-files-found: error
