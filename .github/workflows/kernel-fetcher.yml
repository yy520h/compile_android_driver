name: 拉取谷歌内核源码

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: '安卓版本 (10-15)'
        required: true
      kernel_version:
        description: '内核版本 (4.4-6.6)'
        required: true
      compression:
        description: '压缩格式 (tar.gz, zip, 7z)'
        required: false
        default: 'tar.gz'

jobs:
  fetch_kernel:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 内核同步可能需要较长时间
    
    steps:
      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo
          mkdir android-kernel
          
      - name: Set up Android Kernel source
        run: |
          cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync
          
      - name: Compress kernel source
        id: compress
        run: |
          cd android-kernel
          KERNEL_DIR="android-${{ github.event.inputs.android_version }}-kernel-${{ github.event.inputs.kernel_version }}"
          
          case "${{ github.event.inputs.compression }}" in
            zip)
              7z a -r -mx=9 "$KERNEL_DIR.zip" .
              echo "ARCHIVE_NAME=$KERNEL_DIR.zip" >> $GITHUB_ENV
              ;;
            7z)
              7z a -r -mx=9 "$KERNEL_DIR.7z" .
              echo "ARCHIVE_NAME=$KERNEL_DIR.7z" >> $GITHUB_ENV
              ;;
            *)
              tar --use-compress-program="pigz -9" -cf "$KERNEL_DIR.tar.gz" .
              echo "ARCHIVE_NAME=$KERNEL_DIR.tar.gz" >> $GITHUB_ENV
              ;;
          esac
          
      - name: Upload kernel source
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: android-kernel/${{ env.ARCHIVE_NAME }}
          retention-days: 7
