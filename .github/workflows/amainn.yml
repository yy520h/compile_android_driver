name: OnePlus Pad Pro é©±åŠ¨ç¼–è¯‘ï¼ˆè¯Šæ–­ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      module_name:
        description: 'é©±åŠ¨æ¨¡å—åç§° (å¦‚: qx.ko)'
        required: true
        default: 'mydriver.ko'

jobs:
  build-module:
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    
    steps:
    # ===== 1. ç¯å¢ƒå‡†å¤‡ =====
    - name: å®‰è£…ä¾èµ–
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -yq
        apt-get install -yq git curl build-essential flex bison libssl-dev bc python3 tree
        
        git config --global user.name "builder"
        git config --global user.email "builder@github.com"
        git config --global color.ui false
    
    # ===== 2. å…‹éš†å¹¶æ·±åº¦è¯Šæ–­ =====
    - name: å…‹éš†å¹¶è¯Šæ–­å†…æ ¸ç»“æ„
      run: |
        mkdir -p kernel_workspace && cd kernel_workspace
        
        # å…‹éš†
        git clone --depth=1 -b oneplus/sm8650_b_16.0.0_pad_pro \
          https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650.git kernel
        
        git clone --depth=1 -b oneplus/sm8650_b_16.0.0_pad_pro \
          https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8650.git modules
        
        # ğŸ”¥ æ·±åº¦è¯Šæ–­ï¼šæ‰“å°modulesçš„å®Œæ•´ç»“æ„
        echo "=== è¯Šæ–­modulesç›®å½•ç»“æ„ ==="
        cd modules
        echo "--- é¡¶å±‚ç›®å½• ---"
        ls -la
        
        echo "--- æŸ¥æ‰¾oplusç›¸å…³ç›®å½• ---"
        find . -type d -name "*oplus*" 2>/dev/null | head -20
        
        echo "--- æŸ¥æ‰¾Kconfigæ–‡ä»¶ ---"
        find . -name "Kconfig" 2>/dev/null | head -20
        cd ..
        
        # ğŸ”¥ æ ¹æ®å®é™…ç»“æ„å¤åˆ¶ï¼ˆç´§æ€¥ä¿®å¤ï¼‰
        echo "ğŸ“¦ å¼€å§‹å¤åˆ¶..."
        cd kernel
        
        # å¦‚æœmodulesé‡Œæœ‰kernelç›®å½•ï¼Œå¤åˆ¶å…¶å†…å®¹
        if [ -d "../modules/kernel" ]; then
          echo "å‘ç°modules/kernelï¼Œå¤åˆ¶å…¶å†…å®¹..."
          cp -r ../modules/kernel/* . 2>/dev/null || true
        fi
        
        # ç›´æ¥å¤åˆ¶æ‰€æœ‰å†…å®¹ï¼ˆå¿½ç•¥é”™è¯¯ï¼‰
        cp -r ../modules/* . 2>&1 | tee ../copy.log || true
        
        echo "=== å¤åˆ¶åéªŒè¯ ==="
        ls -la oplus_cpu/ 2>/dev/null || echo "âŒ oplus_cpu ä»æœªæ‰¾åˆ°"
        ls -la drivers/oplus/ 2>/dev/null || echo "âŒ drivers/oplus ä»æœªæ‰¾åˆ°"
        
        echo "âœ“ æ“ä½œå®Œæˆ"
        du -sh .
    
    # ===== 3. é›†æˆæ‚¨çš„é©±åŠ¨æºç  =====
    - name: Checkout driver code
      uses: actions/checkout@v4.2.2
      with:
        path: uploaded_driver
    
    - name: å‡†å¤‡é©±åŠ¨ç›®å½•
      run: |
        cd kernel_workspace/kernel
        
        mkdir -p drivers/oplus_custom
        cp -r ../../uploaded_driver/code/* drivers/oplus_custom/ 2>/dev/null || true
        
        if [ ! -f drivers/oplus_custom/Makefile ]; then
          MODULE_NAME="${{ github.event.inputs.module_name }}"
          DRIVER_DIR="${MODULE_NAME%.ko}"
          echo "obj-m += $DRIVER_DIR/" > drivers/oplus_custom/Makefile
        fi
        
        echo "obj-y += oplus_custom/" >> drivers/Makefile
        
        echo "âœ“ é©±åŠ¨é›†æˆå®Œæˆ:"
        ls -la drivers/oplus_custom/
    
    # ===== 4. é…ç½®å†…æ ¸ï¼ˆå¸¦é”™è¯¯æ”¶é›†ï¼‰=====
    - name: é…ç½®å†…æ ¸
      id: config
      continue-on-error: true  # å…è®¸å¤±è´¥ä»¥ä¾¿ä¸Šä¼ debug
      run: |
        cd kernel_workspace/kernel
        
        echo "=== å†æ¬¡éªŒè¯å…³é”®æ–‡ä»¶ ==="
        ls -l oplus_cpu/sched/Kconfig 2>/dev/null || echo "âš ï¸  è­¦å‘Š: oplus_cpu/sched/Kconfig ä¸å­˜åœ¨"
        
        echo "ğŸ”§ é…ç½®å†…æ ¸..."
        make O=out ARCH=arm64 oplus_debug_defconfig
        
        echo "CONFIG_MODULES=y" >> out/.config
        echo "CONFIG_MODULE_UNLOAD=y" >> out/.config
        
        find out -name "*.ko" -delete
        
        echo "âœ… å†…æ ¸é…ç½®å®Œæˆ"
        echo "CONFIG_SUCCESS=true" >> $GITHUB_OUTPUT
    
    # ===== 5. ç¼–è¯‘é©±åŠ¨æ¨¡å— =====
    - name: ç¼–è¯‘æ¨¡å—
      id: build_module
      if: steps.config.outputs.CONFIG_SUCCESS == 'true'
      continue-on-error: true
      run: |
        cd kernel_workspace/kernel
        
        MODULE_NAME="${{ github.event.inputs.module_name }}"
        MODULE_OBJ="${MODULE_NAME%.ko}.o"
        
        echo "ğŸ”¨ ç¼–è¯‘ $MODULE_NAME ..."
        make O=out ARCH=arm64 LLVM=1 LLVM_IAS=1 CC=clang \
          CROSS_COMPILE=aarch64-linux-gnu- modules_prepare
        
        make O=out ARCH=arm64 LLVM=1 LLVM_IAS=1 CC=clang \
          CROSS_COMPILE=aarch64-linux-gnu- \
          M=drivers/oplus_custom \
          $MODULE_OBJ
        
        if [ -f "out/drivers/oplus_custom/$MODULE_NAME" ]; then
          echo "MODULE_BUILT=true" >> $GITHUB_OUTPUT
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
        else
          echo "MODULE_BUILT=false" >> $GITHUB_OUTPUT
          echo "âŒ ç¼–è¯‘å¤±è´¥"
        fi
    
    # ===== 6. æˆåŠŸï¼šä¸Šä¼ .ko =====
    - name: ä¸Šä¼ é©±åŠ¨æ¨¡å—
      if: steps.build_module.outputs.MODULE_BUILT == 'true'
      uses: actions/upload-artifact@v4.6.2
      with:
        name: "${{ github.event.inputs.module_name }}-oneplus-padpro"
        path: kernel_workspace/kernel/out/drivers/oplus_custom/${{ github.event.inputs.module_name }}
        retention-days: 30
    
    # ===== 7. æ€»æ˜¯ä¸Šä¼ å®Œæ•´è°ƒè¯•åŒ…ï¼ˆä¿®å¤ç‚¹ï¼‰=====
    - name: æ‰“åŒ…å®Œæ•´å†…æ ¸æºç 
      if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
      run: |
        echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…å®Œæ•´å†…æ ¸æºç ..."
        cd kernel_workspace
        
        # åˆ›å»ºè°ƒè¯•åŒ…ï¼ˆåŒ…å«æ•´ä¸ªkernelæºç ï¼‰
        mkdir -p debug_bundle
        
        # å¤åˆ¶æ•´ä¸ªå†…æ ¸ç›®å½•ï¼ˆåŒ…æ‹¬æ‰€æœ‰æºç ï¼‰
        cp -r kernel/* debug_bundle/ 2>/dev/null || true
        
        # å¤åˆ¶ä¸Šä¼ çš„é©±åŠ¨æºç 
        if [ -d ../uploaded_driver/code ]; then
          mkdir -p debug_bundle/uploaded_driver
          cp -r ../uploaded_driver/code/* debug_bundle/uploaded_driver/ 2>/dev/null || true
        fi
        
        # åˆ›å»ºä¿¡æ¯æ–‡ä»¶
        cat > debug_bundle/BUILD_INFO.txt <<EOF
        Build Date: $(date)
        Module Name: ${{ github.event.inputs.module_name }}
        Config Success: ${{ steps.config.outputs.CONFIG_SUCCESS }}
        Build Success: ${{ steps.build_module.outputs.MODULE_BUILT }}
        
        ç›®å½•ç»“æ„:
        $(tree -L 2 debug_bundle/ 2>/dev/null || find debug_bundle -maxdepth 2)
        
        æŸ¥æ‰¾oplus_cpu:
        $(find debug_bundle -name "Kconfig" | grep oplus)
        EOF
        
        # å‹ç¼©ï¼ˆæ’é™¤.gitä»¥å‡å°ä½“ç§¯ï¼‰
        tar --exclude='.git' -czf /tmp/kernel_debug.tar.gz -C debug_bundle .
        
        echo "DEBUG_SIZE=$(du -sh /tmp/kernel_debug.tar.gz | cut -f1)" >> $GITHUB_ENV
        echo "æ‰“åŒ…å®Œæˆ: $(du -sh /tmp/kernel_debug.tar.gz)"
    
    - name: ä¸Šä¼ å®Œæ•´å†…æ ¸åŒ…ï¼ˆæ€»æ˜¯æ‰§è¡Œï¼‰
      if: always()
      uses: actions/upload-artifact@v4.6.2
      with:
        name: "kernel-source-sm8650-android16"
        path: /tmp/kernel_debug.tar.gz
        retention-days: 3  # çŸ­æœŸä¿ç•™ï¼Œé¿å…å ç”¨ç©ºé—´
    
    # ===== 8. ç»“æœæ€»ç»“ =====
    - name: æ„å»ºç»“æœ
      run: |
        echo "=== æ„å»ºæ€»ç»“ ==="
        echo "é…ç½®æˆåŠŸ: ${{ steps.config.outputs.CONFIG_SUCCESS }}"
        echo "ç¼–è¯‘æˆåŠŸ: ${{ steps.build_module.outputs.MODULE_BUILT }}"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½é“¾æ¥:"
        echo "  - å†…æ ¸æºç åŒ…: kernel-source-sm8650-android16.tar.gz (${{ env.DEBUG_SIZE }})"
        if [ "${{ steps.build_module.outputs.MODULE_BUILT }}" = "true" ]; then
          echo "  - é©±åŠ¨æ¨¡å—: ${{ github.event.inputs.module_name }}-oneplus-padpro"
        fi
