name: æ‹‰å–OnePluså†…æ ¸å¹¶æ‰“åŒ…

on:
  workflow_dispatch:

jobs:
  pack-kernel:
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    
    steps:
    # 1. å®‰è£…ä¾èµ–
    - name: å®‰è£…ä¾èµ–
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -yq
        apt-get install -yq git curl
        
        git config --global user.name "builder"
        git config --global user.email "builder@github.com"
    
    # 2. å…‹éš†ä¸¤ä¸ªä»“åº“ï¼ˆæ”¾åˆ°ç‹¬ç«‹ç›®å½•ï¼‰
    - name: å…‹éš†å†…æ ¸æºç 
      run: |
        mkdir -p kernel_workspace
        cd kernel_workspace
        
        echo "ğŸ”„ å…‹éš†ä¸»å†…æ ¸..."
        git clone --depth=1 -b oneplus/sm8650_b_16.0.0_pad_pro \
          https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650.git
        
        echo "ğŸ”„ å…‹éš†æ¨¡å—å’Œè®¾å¤‡æ ‘..."
        git clone --depth=1 -b oneplus/sm8650_b_16.0.0_pad_pro \
          https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8650.git
        
        echo "âœ“ å…‹éš†å®Œæˆ"
        du -sh */  # æ˜¾ç¤ºæ¯ä¸ªç›®å½•å¤§å°
    
    # 3. ç›´æ¥æ‰“åŒ…ä¸¤ä¸ªç‹¬ç«‹ç›®å½•ï¼ˆä¿ç•™.gitï¼‰
    - name: æ‰“åŒ…æºç 
      run: |
        cd kernel_workspace
        
        echo "ğŸ“¦ æ‰“åŒ…å®Œæ•´æºç ..."
        # æ‰“åŒ…ä¸¤ä¸ªç›®å½•ï¼Œä¿æŒç‹¬ç«‹ï¼ˆæ–¹ä¾¿æŸ¥çœ‹ï¼‰
        tar -czf /tmp/oneplus_kernel_full.tar.gz \
          --exclude='*.tmp' --exclude='*.log' \
          android_kernel_oneplus_sm8650/ \
          android_kernel_modules_and_devicetree_oneplus_sm8650/
        
        echo "=== æ‰“åŒ…ç»“æœ ==="
        ls -lh /tmp/oneplus_kernel_full.tar.gz
        SIZE=$(stat -c%s /tmp/oneplus_kernel_full.tar.gz)
        echo "SIZE_MB=$(( $SIZE / 1024 / 1024 ))" >> $GITHUB_ENV
    
    # 4. ä¸Šä¼ 
    - name: ä¸Šä¼ æºç åŒ…
      uses: actions/upload-artifact@v4.6.2
      with:
        name: "oneplus-kernel-sm8650-source"
        path: /tmp/oneplus_kernel_full.tar.gz
        retention-days: 7
    
    # 5. è¯´æ˜
    - name: ä½¿ç”¨è¯´æ˜
      run: |
        echo "âœ… æ‰“åŒ…å®Œæˆï¼"
        echo "ğŸ“¦ æ–‡ä»¶å: oneplus-kernel-sm8650-source.tar.gz"
        echo "ğŸ“Š å¤§å°: ${{ env.SIZE_MB }} MB"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½åè§£å‹:"
        echo "   tar -xzf oneplus-kernel-sm8650-source.tar.gz"
        echo ""
        echo "ğŸ” æœ¬åœ°æŸ¥æ‰¾oplus_cpu:"
        echo "   find . -name 'Kconfig' | grep oplus_cpu"
        echo ""
        echo "ğŸ“‚ ç›®å½•ç»“æ„:"
        echo "   android_kernel_oneplus_sm8650/     # ä¸»å†…æ ¸"
        echo "   android_kernel_modules_and_devicetree_oneplus_sm8650/  # æ¨¡å—"
