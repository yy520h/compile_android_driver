name: æ‹‰å–OnePluså†…æ ¸æºç å¹¶æ‰“åŒ…

on:
  workflow_dispatch:

jobs:
  fetch-and-pack:
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    
    steps:
    # ===== 1. å®‰è£…ä¾èµ– =====
    - name: å®‰è£…ä¾èµ–
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -yq
        apt-get install -yq git curl
        
        git config --global user.name "builder"
        git config --global user.email "builder@github.com"
        git config --global color.ui false
    
    # ===== 2. å…‹éš†å†…æ ¸æºç  =====
    - name: å…‹éš†å†…æ ¸æºç 
      run: |
        mkdir -p kernel_workspace
        cd kernel_workspace
        
        echo "ğŸ”„ å…‹éš†ä¸»å†…æ ¸..."
        git clone --depth=1 -b oneplus/sm8650_b_16.0.0_pad_pro \
          https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650.git kernel
        
        echo "ğŸ”„ å…‹éš†æ¨¡å—å’Œè®¾å¤‡æ ‘..."
        git clone --depth=1 -b oneplus/sm8650_b_16.0.0_pad_pro \
          https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8650.git modules
        
        echo "âœ“ å…‹éš†å®Œæˆ"
    
    # ===== 3. åˆå¹¶modulesåˆ°kernel =====
    - name: åˆå¹¶modulesåˆ°kernel
      run: |
        # ä½¿ç”¨æ­£ç¡®çš„ç›¸å¯¹è·¯å¾„
        cd kernel_workspace/kernel
        
        echo "ğŸ“¦ åˆå¹¶modulesåˆ°kernel..."
        cp -r ../modules/* . 2>/dev/null || true
        
        echo "=== éªŒè¯å…³é”®æ–‡ä»¶ ==="
        ls -l oplus_cpu/sched/Kconfig 2>/dev/null || echo "âš ï¸ oplus_cpu/sched/Kconfig ä¸å­˜åœ¨"
        
        echo "=== æœ€ç»ˆç›®å½•å¤§å° ==="
        du -sh .
    
    # ===== 4. å‹ç¼©å®Œæ•´æºç  =====
    - name: æ‰“åŒ…å®Œæ•´æºç 
      run: |
        cd kernel_workspace
        
        echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…..."
        # åŒ…å«æ‰€æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬.gitï¼‰
        tar -czf /tmp/oneplus_kernel_sm8650_android16.tar.gz kernel/
        
        echo "=== æ‰“åŒ…ç»“æœ ==="
        ls -lh /tmp/oneplus_kernel_sm8650_android16.tar.gz
        echo "SIZE=$(stat -c%s /tmp/oneplus_kernel_sm8650_android16.tar.gz)" >> $GITHUB_ENV
    
    # ===== 5. ä¸Šä¼  =====
    - name: ä¸Šä¼ æºç åŒ…
      uses: actions/upload-artifact@v4.6.2
      with:
        name: "oneplus-kernel-sm8650-android16"
        path: /tmp/oneplus_kernel_sm8650_android16.tar.gz
        retention-days: 7
    
    # ===== 6. ç»“æœé€šçŸ¥ =====
    - name: å®Œæˆé€šçŸ¥
      run: |
        SIZE_MB=$(( $SIZE / 1024 / 1024 ))
        echo "âœ… æ‰“åŒ…å®Œæˆï¼"
        echo "ğŸ“¦ æ–‡ä»¶å: oneplus-kernel-sm8650-android16.tar.gz"
        echo "ğŸ“Š å¤§å°: ${SIZE_MB} MB"
        echo "â¬‡ï¸  è¯·ä»Artifactsä¸‹è½½"
