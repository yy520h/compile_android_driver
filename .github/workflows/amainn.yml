name: æ‹‰å–OnePluså†…æ ¸æºç å¹¶æ‰“åŒ…

on:
  workflow_dispatch:

jobs:
  fetch-and-pack:
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    
    steps:
    # ===== 1. å®‰è£…ä¾èµ– =====
    - name: å®‰è£…ä¾èµ–
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -yq
        apt-get install -yq git curl
    
    # ===== 2. å…‹éš†å†…æ ¸æºç  =====
    - name: å…‹éš†å†…æ ¸æºç 
      run: |
        mkdir -p kernel_workspace && cd kernel_workspace
        
        echo "ğŸ”„ å…‹éš†ä¸»å†…æ ¸..."
        git clone --depth=1 -b oneplus/sm8650_b_16.0.0_pad_pro \
          https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650.git
        
        echo "ğŸ”„ å…‹éš†æ¨¡å—å’Œè®¾å¤‡æ ‘..."
        git clone --depth=1 -b oneplus/sm8650_b_16.0.0_pad_pro \
          https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8650.git modules
        
        echo "âœ“ å…‹éš†å®Œæˆ"
    
    # ===== 3. ç®€å•åˆå¹¶ï¼ˆä¸å¤åˆ¶.gitï¼‰=====
    - name: åˆå¹¶modulesåˆ°kernel
      run: |
        cd kernel_workspace/kernel
        
        echo "ğŸ“¦ åˆå¹¶modulesï¼ˆæ’é™¤.gitï¼‰..."
        cp -r ../modules/* . 2>/dev/null || true
        
        echo "=== æœ€ç»ˆç›®å½•å¤§å° ==="
        du -sh .
        
        echo "=== å…³é”®è·¯å¾„æ£€æŸ¥ ==="
        ls -ld oplus_cpu oplus_cpu/sched drivers/oplus vendor/oplus 2>/dev/null || echo "éƒ¨åˆ†è·¯å¾„ä¸å­˜åœ¨"
    
    # ===== 4. å‹ç¼©å®Œæ•´æºç ï¼ˆåŒ…å«.gitï¼‰=====
    - name: æ‰“åŒ…å®Œæ•´æºç 
      run: |
        cd kernel_workspace
        
        echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…..."
        # å‹ç¼©æ•´ä¸ªkernelç›®å½•ï¼ˆåŒ…å«.gitï¼Œä¿æŒGitä¿¡æ¯ï¼‰
        tar -czf /tmp/oneplus_kernel_sm8650_android16.tar.gz kernel/
        
        echo "=== æ‰“åŒ…ç»“æœ ==="
        ls -lh /tmp/oneplus_kernel_sm8650_android16.tar.gz
        echo "SIZE=$(stat -c%s /tmp/oneplus_kernel_sm8650_android16.tar.gz)" >> $GITHUB_ENV
    
    # ===== 5. ä¸Šä¼  =====
    - name: ä¸Šä¼ æºç åŒ…
      uses: actions/upload-artifact@v4.6.2
      with:
        name: "oneplus-kernel-sm8650-android16"
        path: /tmp/oneplus_kernel_sm8650_android16.tar.gz
        retention-days: 7
    
    # ===== 6. ç»“æœé€šçŸ¥ =====
    - name: å®Œæˆé€šçŸ¥
      run: |
        SIZE_MB=$(( $SIZE / 1024 / 1024 ))
        echo "âœ… æ‰“åŒ…å®Œæˆï¼"
        echo "ğŸ“¦ æ–‡ä»¶å: oneplus-kernel-sm8650-android16.tar.gz"
        echo "ğŸ“Š å¤§å°: ${SIZE_MB} MB"
        echo "â¬‡ï¸  è¯·ä»Artifactsä¸‹è½½"
