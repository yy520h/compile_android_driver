name: OnePlus Pad Pro é©±åŠ¨ç¼–è¯‘

on:
  workflow_dispatch:
    inputs:
      module_name:
        description: 'é©±åŠ¨æ¨¡å—åç§° (å¦‚: qx.ko)'
        required: true
        default: 'mydriver.ko'

jobs:
  build-module:
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    
    steps:
    # ===== 1. ç¯å¢ƒå‡†å¤‡ =====
    - name: å®‰è£…ä¾èµ–
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -yq
        apt-get install -yq git curl build-essential flex bison libssl-dev bc python3
        
        git config --global user.name "builder"
        git config --global user.email "builder@github.com"
        git config --global color.ui false
    
    # ===== 2. å…‹éš†å¹¶åˆå¹¶å†…æ ¸æºç  =====
    - name: å…‹éš†å†…æ ¸æºç ï¼ˆä¿®å¤ç‚¹ï¼‰=====
      run: |
        mkdir -p kernel_workspace && cd kernel_workspace
        
        # å…‹éš†ä¸»å†…æ ¸
        echo "ğŸ”„ æ­£åœ¨å…‹éš†ä¸»å†…æ ¸..."
        git clone --depth=1 -b oneplus/sm8650_b_16.0.0_pad_pro \
          https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650.git kernel
        
        # å…‹éš†æ¨¡å—å’Œè®¾å¤‡æ ‘
        echo "ğŸ”„ æ­£åœ¨å…‹éš†æ¨¡å—å’Œè®¾å¤‡æ ‘..."
        git clone --depth=1 -b oneplus/sm8650_b_16.0.0_pad_pro \
          https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8650.git modules
        
        # ğŸ”¥ å…³é”®ä¿®å¤ï¼šé“¾æ¥modulesä¸­çš„oplusä»£ç åˆ°kernel
        echo "ğŸ”§ æ­£åœ¨é“¾æ¥vendoræ¨¡å—..."
        cd kernel
        
        # å¦‚æœkernelä¸­oplus_cpuä¸å­˜åœ¨ï¼Œä»moduleså¤åˆ¶æˆ–é“¾æ¥
        if [ ! -d "oplus_cpu" ] && [ -d "../modules/oplus_cpu" ]; then
          echo "åˆ›å»ºoplus_cpuç¬¦å·é“¾æ¥..."
          ln -s ../modules/oplus_cpu oplus_cpu
        fi
        
        # åŒæ ·å¤„ç†å…¶ä»–å¯èƒ½çš„vendorç›®å½•
        for dir in drivers/oplus drivers/soc/qcom/oplus; do
          if [ ! -d "$dir" ] && [ -d "../modules/$dir" ]; then
            mkdir -p $(dirname $dir)
            ln -s ../../modules/$dir $dir 2>/dev/null || true
          fi
        done
        
        echo "âœ“ æºç æ‹‰å–å¹¶é“¾æ¥å®Œæˆ"
        du -sh . ../modules
    
    # ===== 3. é›†æˆæ‚¨çš„é©±åŠ¨æºç  =====
    - name: Checkout driver code
      uses: actions/checkout@v4.2.2
      with:
        path: uploaded_driver
    
    - name: é›†æˆåˆ°å†…æ ¸æ ‘
      run: |
        cd kernel_workspace/kernel
        
        # åˆ›å»ºé©±åŠ¨ç›®å½•
        mkdir -p drivers/oplus_custom
        
        # å¤åˆ¶ä¸Šä¼ çš„æºç 
        cp -r ../../uploaded_driver/code/* drivers/oplus_custom/ 2>/dev/null || true
        
        # ç¡®ä¿Makefileå­˜åœ¨
        if [ ! -f drivers/oplus_custom/Makefile ]; then
          MODULE_NAME="${{ github.event.inputs.module_name }}"
          DRIVER_DIR="${MODULE_NAME%.ko}"
          echo "obj-m += $DRIVER_DIR/" > drivers/oplus_custom/Makefile
        fi
        
        # æ·»åŠ åˆ°çˆ¶Makefile
        echo "obj-y += oplus_custom/" >> drivers/Makefile
        
        echo "âœ“ é©±åŠ¨æºç å·²é›†æˆ"
        ls -la drivers/oplus_custom/
    
    # ===== 4. é…ç½®å†…æ ¸ï¼ˆä¿®å¤ç‚¹ï¼‰=====
    - name: é…ç½®å†…æ ¸
      run: |
        cd kernel_workspace/kernel
        
        # ğŸ”¥ å…ˆæ£€æŸ¥å¯ç”¨çš„defconfig
        echo "=== å¯ç”¨çš„defconfig ==="
        find arch/arm64/configs -name "*defconfig" | head -10
        
        # ğŸ”¥ å°è¯•ä½¿ç”¨vendoré…ç½®ï¼Œå¦‚æœå¤±è´¥åˆ™å›é€€
        if [ -f "arch/arm64/configs/vendor/oplus_caihong_defconfig" ]; then
          echo "ä½¿ç”¨ vendor/oplus_caihong_defconfig"
          make O=out ARCH=arm64 vendor/oplus_caihong_defconfig
        elif [ -f "arch/arm64/configs/vendor/sm8650_defconfig" ]; then
          echo "ä½¿ç”¨ vendor/sm8650_defconfig (å›é€€)"
          make O=out ARCH=arm64 vendor/sm8650_defconfig
        else
          echo "ä½¿ç”¨é»˜è®¤defconfig (æœ€ç»ˆå›é€€)"
          make O=out ARCH=arm64 defconfig
        fi
        
        # ç¡®ä¿æ¨¡å—ç¼–è¯‘å¯ç”¨
        echo "CONFIG_MODULES=y" >> out/.config
        echo "CONFIG_MODULE_UNLOAD=y" >> out/.config
        
        # æ¸…ç†æ—§äº§ç‰©
        find out -name "*.ko" -delete
        
        echo "âœ“ å†…æ ¸é…ç½®å®Œæˆ"
    
    # ===== 5. ç¼–è¯‘é©±åŠ¨æ¨¡å— =====
    - name: ç¼–è¯‘æ¨¡å—
      id: build_module
      run: |
        cd kernel_workspace/kernel
        
        MODULE_NAME="${{ github.event.inputs.module_name }}"
        MODULE_OBJ="${MODULE_NAME%.ko}.o"
        
        # ç¼–è¯‘æ¨¡å—ä¾èµ–
        echo "ğŸ”¨ å‡†å¤‡æ¨¡å—ç¯å¢ƒ..."
        make O=out ARCH=arm64 LLVM=1 LLVM_IAS=1 CC=clang \
          CROSS_COMPILE=aarch64-linux-gnu- modules_prepare
        
        # ç¼–è¯‘é©±åŠ¨
        echo "ğŸ”¨ ç¼–è¯‘ $MODULE_NAME ..."
        make O=out ARCH=arm64 LLVM=1 LLVM_IAS=1 CC=clang \
          CROSS_COMPILE=aarch64-linux-gnu- \
          M=drivers/oplus_custom \
          $MODULE_OBJ
        
        # æ£€æŸ¥äº§ç‰©
        if [ -f "out/drivers/oplus_custom/$MODULE_NAME" ]; then
          echo "MODULE_BUILT=true" >> $GITHUB_OUTPUT
          echo "âœ… é©±åŠ¨ç¼–è¯‘æˆåŠŸï¼æ–‡ä»¶å¤§å°: $(ls -lh out/drivers/oplus_custom/$MODULE_NAME | awk '{print $5}')"
        else
          echo "MODULE_BUILT=false" >> $GITHUB_OUTPUT
          echo "âŒ é©±åŠ¨ç¼–è¯‘å¤±è´¥"
          echo "=== ç›®å½•å†…å®¹ ==="
          find out/drivers/oplus_custom -type f 2>/dev/null || true
          exit 1
        fi
    
    # ===== 6. æˆåŠŸï¼šä¸Šä¼ .ko =====
    - name: ä¸Šä¼ é©±åŠ¨æ¨¡å—
      if: steps.build_module.outputs.MODULE_BUILT == 'true'
      uses: actions/upload-artifact@v4.6.2
      with:
        name: "${{ github.event.inputs.module_name }}-oneplus-padpro"
        path: kernel_workspace/kernel/out/drivers/oplus_custom/${{ github.event.inputs.module_name }}
        retention-days: 30
    
    # ===== 7. å¤±è´¥ï¼šä¸Šä¼ å…¨éƒ¨è°ƒè¯•ä¿¡æ¯ =====
    - name: æ‰“åŒ…è°ƒè¯•ä¿¡æ¯
      if: failure()
      run: |
        echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…è°ƒè¯•ä¿¡æ¯..."
        cd kernel_workspace
        
        mkdir -p debug_bundle
        
        # æ‰€æœ‰ç¼–è¯‘äº§ç‰©
        if [ -d kernel/out/drivers/oplus_custom ]; then
          cp -r kernel/out/drivers/oplus_custom/* debug_bundle/ 2>/dev/null || true
        fi
        
        # æºç 
        if [ -d ../uploaded_driver/code ]; then
          cp -r ../uploaded_driver/code/* debug_bundle/source/ 2>/dev/null || true
        fi
        
        # ç¼–è¯‘æ—¥å¿—
        find kernel/out -name "*.log" -exec cp {} debug_bundle/ \; 2>/dev/null || true
        
        # é…ç½®å’ŒMakefile
        cp kernel/out/.config debug_bundle/ 2>/dev/null || true
        cp kernel/drivers/oplus_custom/Makefile debug_bundle/ 2>/dev/null || true
        
        # æ‰“åŒ…
        tar -czf /tmp/debug_bundle.tar.gz -C debug_bundle .
        echo "DEBUG_SIZE=$(du -sh /tmp/debug_bundle.tar.gz | cut -f1)" >> $GITHUB_ENV
    
    - name: ä¸Šä¼ è°ƒè¯•åŒ…
      if: failure()
      uses: actions/upload-artifact@v4.6.2
      with:
        name: "debug-all-${{ github.run_id }}"
        path: /tmp/debug_bundle.tar.gz
        retention-days: 7
    
    # ===== 8. æ€»ç»“ =====
    - name: æ„å»ºç»“æœ
      run: |
        if [ "${{ steps.build_module.outputs.MODULE_BUILT }}" = "true" ]; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸï¼è¯·ä¸‹è½½ .ko æ–‡ä»¶"
          echo "adb push <æ–‡ä»¶> /data/local/tmp/"
          echo "adb shell su -c 'insmod /data/local/tmp/${{ github.event.inputs.module_name }}'"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"
          echo "ğŸ“¥ è¯·ä¸‹è½½ debug-all-${{ github.run_id }}.tar.gz"
          echo "ğŸ“¦ å¤§å°: ${{ env.DEBUG_SIZE }}"
        fi
